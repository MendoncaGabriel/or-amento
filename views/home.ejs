<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Orçamento</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.tailwindcss.com"></script>

</head>
<body class="bg-gray-200 space-y-5">
    <!-- NAVBAR -->
    <section class="bg-blue-700 mb-5 p-4 drop-shadow-md">
        <div class="w-full max-w-screen-md m-auto flex items-center justify-between">
            <img src="/images/logo.png" alt="" class="w-32">
            <h1 class="text-center font-semibold text-4xl text-gray-100">MICRO SISTEMAS</h1>
        </div>
    </section>

    <!-- BUSCADOR -->
    <section class="w-full max-w-screen-md m-auto h-full bg-white p-4 rounded-md shadow-md space-y-5">
        <div class="flex items-center justify-center space-x-4">
            <hr class="flex-grow border-gray-300">
            <h1 class="text-center font-semibold text-xl text-gray-600">GERADOR DE ORÇAMENTO</h1>
            <hr class="flex-grow border-gray-300">
        </div>

        <div class="flex items-center justify-center space-x-2">
            <input id="inputEAN" type="text" class="px-4 py-2 shadow-md rounded-sm border w-full" placeholder="Codigo Auxiliar">
            <button onclick="buscarProduto()" class="px-4 p-2 bg-blue-600 hover:bg-blue-700 duration-100 hover:drop-shadow-sm text-white font-semibold">Buscar</button>
        </div>
    </section>

    <!-- OBSERVAÇÕES -->
    <section class="w-full max-w-screen-md m-auto h-full bg-white p-4 rounded-md shadow-md space-y-5">
        <div class="flex items-center justify-center space-x-4">
            <hr class="flex-grow border-gray-300">
            <button id="" class="text-center font-semibold text-xl text-gray-600 hover:text-blue-500 duration-200 ">OBSERVAÇÕES</button>
            <hr class="flex-grow border-gray-300">
        </div>

        <form class="space-y-4" id="">

            <div>
                <textarea name="" id="observacoes" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>               
            </div>
      
        </form>
        
    </section>

    <!-- CADASTRO CLIENTE -->
    <section class="w-full max-w-screen-md m-auto h-full bg-white p-4 rounded-md shadow-md space-y-5">
        <div class="flex items-center justify-center space-x-4">
            <hr class="flex-grow border-gray-300">
            <button id="btnOpenCloseFormCadastroCliente" class="text-center font-semibold text-xl text-gray-600 hover:text-blue-500 duration-200 ">DADOS DO CLIENTE</button>
            <hr class="flex-grow border-gray-300">
        </div>

        <div class="space-y-4 hidden" id="formCadastroCliente">
            <div>
                <label for="nome" class="block text-sm font-medium text-gray-700">Nome</label>
                <input type="text" id="nome" name="nome" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="João da Silva">
            </div>
            <div>
                <label for="telefone" class="block text-sm font-medium text-gray-700">Telefone</label>
                <input type="text" id="telefone" name="telefone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="(11) 98765-4321">
            </div>
            <div>
                <label for="cpf_cnpj" class="block text-sm font-medium text-gray-700">CPF/CNPJ</label>
                <input type="text" id="cpf_cnpj" name="cpf_cnpj" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="123.456.789-00">
            </div>
            <div>
                <label for="endereco" class="block text-sm font-medium text-gray-700">Endereço</label>
                <input type="text" id="endereco" name="endereco" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Rua Exemplo, 123">
            </div>
            <div>
                <label for="bairro" class="block text-sm font-medium text-gray-700">Bairro</label>
                <input type="text" id="bairro" name="bairro" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Centro">
            </div>
            <div>
                <label for="cidade" class="block text-sm font-medium text-gray-700">Cidade</label>
                <input type="text" id="cidade" name="cidade" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="São Paulo">
            </div>
            <div>
                <label for="estado" class="block text-sm font-medium text-gray-700">Estado</label>
                <input type="text" id="estado" name="estado" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="SP">
            </div>
            <div>
                <label for="cep" class="block text-sm font-medium text-gray-700">CEP</label>
                <input type="text" id="cep" name="cep" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="01234-567">
            </div>
            <div class="flex justify-center space-x-4">
                <button type="button" id="btnCreateClient" onclick="buscarCliente()" class="px-4 p-2 bg-green-600 hover:bg-green-700 duration-100 hover:drop-shadow-sm text-white font-semibold">Buscar</button>
            </div>
        </div>
        <script>
            function buscarCliente(){
                fetch(`/api/cliente/asdf`, {
                    method: "GET",
                    headers: {"Content-Type": "application/json"},
                })
                .then(res => res.json())
                .then(res => {
                    console.log(res)
                    preencherFormulario(res.cliente)
                })
            }

            function preencherFormulario(cliente){
                document.getElementById("nome").value = cliente.nome
                document.getElementById("telefone").value = cliente.telefone
                document.getElementById("cpf_cnpj").value = cliente.cpf_cnpj
                document.getElementById("endereco").value = cliente.endereco
                document.getElementById("bairro").value = cliente.bairro
                document.getElementById("cidade").value = cliente.cidade
                document.getElementById("estado").value = cliente.estado
                document.getElementById("cep").value = cliente.cep
            }


        </script>

        

        <script>
            const formCadastroCliente = document.getElementById("formCadastroCliente")
            const btnOpenCloseFormCadastroCliente = document.getElementById("btnOpenCloseFormCadastroCliente")
            
            let open = false;
            btnOpenCloseFormCadastroCliente.addEventListener('click', () => {
                if(open == false){
                    formCadastroCliente.classList.remove("hidden")
                    open = true
                }else{
                    formCadastroCliente.classList.add("hidden")
                    open = false
                }
            })
        </script>
        
    </section>

    <!-- LISTA PRODUTOS ORÇAMENTO -->
    <section class="w-full max-w-screen-md m-auto h-full bg-white p-4 rounded-md shadow-md space-y-5">
        <div class="flex items-center justify-center space-x-4">
            <hr class="flex-grow border-gray-300">
            <h1 class="text-center font-semibold text-xl text-gray-600">LISTA DE PRODUTOS</h1>
            <hr class="flex-grow border-gray-300">
        </div>

        <div class="relative inline-block w-full">
            <select 
                id="paymentMethod" 
                name="paymentMethod"
                class="block w-full py-2 px-3 border border-gray-300 rounded-lg bg-white text-gray-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
            >
                <option value="atacado">PIX E DINHEIRO</option>
                <option value="boleto">DECORADOR</option>
                <option value="varejo" >DEBITO E CREDITO</option>
            </select>
        </div>

        <button onclick="gerarOrçamento()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            Gerar Orçamento
        </button>
        

        <table class="min-w-full bg-white shadow-md">
            <thead>
                <tr class="bg-gray-800 text-white">
                    <th class="py-3 px-6 text-left">Item</th>
                    <th class="py-3 px-6 text-left">Produto/Serviço</th>
                    <th class="py-3 px-6 text-left">Quantidade</th>
                    <th class="py-3 px-6 text-left">Valor</th>
                    <th class="py-3 px-6 text-left">Total</th>
                    <th class="py-3 px-6 text-left ">Remover</th>
                </tr>
            </thead>
            <tbody id="listaProduto"></tbody>
        </table>
        
    </section>
    
</body>
</html>
<script>
    function getSelectedOptionText() {
        // Obter o elemento select
        const selectElement = document.getElementById('paymentMethod');
        
        // Obter o índice da opção selecionada
        const selectedIndex = selectElement.selectedIndex;
        
        // Obter a opção selecionada
        const selectedOption = selectElement.options[selectedIndex];
        
        // Obter o texto interno da opção selecionada
        const selectedOptionText = selectedOption.innerText;
        
        return selectedOptionText;
    }
    
    function verificarFomCliente(){
        if(document.getElementById("nome").value.length == 0 ){
            alert("Verifique o nome do cliente")
            return "interromper"
        }
         
            
        // document.getElementById("telefone").value
        // document.getElementById("cpf_cnpj").value
        // document.getElementById("endereco").value
        // document.getElementById("bairro").value
        // document.getElementById("cidade").value
        // document.getElementById("estado").value
        // document.getElementById("cep").value
    }

    async function gerarOrçamento() {
        if(verificarFomCliente() == "interromper") return;

        const listaProdutos = getListaProdutos();
        const formaPagamento =  getSelectedOptionText();
        const observacoes = document.getElementById('observacoes').value;
        const cliente = {
            nome: document.getElementById("nome").value,
            telefone: document.getElementById("telefone").value,
            cpf_cnpj: document.getElementById("cpf_cnpj").value,
            endereco: document.getElementById("endereco").value,
            bairro: document.getElementById("bairro").value,
            cidade: document.getElementById("cidade").value,
            estado: document.getElementById("estado").value,
            cep: document.getElementById("cep").value
        }

        if(!listaProdutos) return alert("Itens não foram adicionados!")
        console.log(listaProdutos)

        fetch('/api/orcamento/create', {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                produtos: listaProdutos,
                formaPagamento: formaPagamento,
                observacoes: observacoes,
                cliente: cliente
            })
        })
        .then(res => res.json())
        .then(res => {
            console.log(res)
            const id = res.novoOrcamento.id
            location.href = `/orcamento/${id}`
        })

        console.log(listaProdutos)
        
    }

    function getListaProdutos(){
        const listaProduto = document.querySelectorAll('#listaProduto tr');
        const produtos = [];

        listaProduto.forEach(tr => {
            const tds = tr.querySelectorAll('td');
            if (tds.length > 0) { // Verifica se há células na linha
                const produto = {
                    productId: tds[0].textContent.trim(),
                    descricao: tds[1].textContent.trim(),
                    quantidade: tds[2].querySelector('input').value.trim(),
                    price: tds[3].textContent.trim().replace('R$ ', ''),
                    total: tds[4].textContent.trim().replace('R$ ', '')
                };
                produtos.push(produto);
            }
        });
        return produtos
    }

    function buscarEndereco(cep) {
        return new Promise((resolve, reject) => {
            if(!cep) throw new Error('cep não informado')
            fetch(`https://viacep.com.br/ws/${cep}/json/`)
            .then(res => res.json())
            .then(res => {
                resolve(res)
            })
            .catch(error => {
                reject(error)
            });
        })
    }

    //lidar input
    const inputCep = document.getElementById('cep');
    inputCep.addEventListener('keyup', (event) =>{
        handleInputCep(event.target.value)
    })

    //preencher inputs com resultado
    async function handleInputCep(cep){
        if(cep.length == 8){
            const endereco = await buscarEndereco(cep);
            console.log(endereco)
            document.querySelector('#bairro').value = endereco.bairro || '';
            document.querySelector('#endereco').value = endereco.complemento || '';
            document.querySelector('#cidade').value = endereco.localidade || '';
            document.querySelector('#endereco').value = endereco.logradouro || '';
            document.querySelector('#estado').value = endereco.uf || '';

        }
    }

  


      
    
     

    function updateTotal(element) {
        let quantity = element.value;
        let priceElement = element.closest('tr').querySelector('.price');
        let totalElement = element.closest('tr').querySelector('.total');
        
        let price = parseFloat(priceElement.innerText.replace('R$ ', ''));
        let total = (quantity * price).toFixed(2);
        
        totalElement.innerText = "R$ " + total;
    }

    function idAleatorio() {
        return Math.floor(10000000 + Math.random() * 90000000);
    }

    function addProduto({productId, descricao, price}){
        const listaProduto = document.getElementById('listaProduto');
        const id = "tr" + idAleatorio();
        listaProduto.innerHTML += `
        <tr class="border-b border-gray-200" id="${id}">
            <td class="py-3 px-6">${productId}</td>
            <td class="py-3 px-6 text-sm min-w-52">${descricao}</td>
            <td class="py-3 px-6">
                <input type="number" max="99" min="1" class="border quantity text-center" value="1" oninput="updateTotal(this)">
            </td>
                <td class="p-2 price w-20">R$ ${price}</td>
                <td class="p-2 total w-20">R$ ${price}</td>
                <td class="py-3 px-6">
                <button onclick="btnRemove('${id}')" class="bg-red-500 hover:bg-red-600 hover:shadow-md duration-100 flex items-center justify-center px-5 py-2 rounded-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-trash-fil text-white" viewBox="0 0 16 16">
                        <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5M8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5m3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0"/>
                    </svg>
                </button>
            </td>
        </tr>
        `;
    }

    function btnRemove(tr){
        document.getElementById(tr).remove();
    }

    function buscarProduto(){
        const inputEAN = document.getElementById('inputEAN')
        if(inputEAN.value.length == 0) return alert("digite o codigo de barras!")

        fetch(`/api/produto/${inputEAN.value}`, {
            method: "GET",
            headers: {"Content-Type":"application/json"}
        })
        .then(res => res.json())
        .then(res => {
            console.log(res)
            addProduto({
                productId: res.produto.productId,
                descricao: res.produto.descricao,
                price: res.produto.price[getpaymentMethod()]

                // atacado - pix e  dinheito
                // boleto - decorador 
                // varejo - debito e credito
            })
            trancarSelectTabela()
        })
    }
    
    function getpaymentMethod(){
        const selectElement = document.getElementById('paymentMethod');
        console.log(selectElement)
        return selectElement.value
    }

    function trancarSelectTabela() {
        const selectElement = document.getElementById('paymentMethod');
        selectElement.disabled = true;
    }
</script>